<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Video API Client</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;--bg-grad-1:#0f172a;--bg-grad-2:#111827;--card:rgba(255,255,255,0.06);
      --card-border:rgba(255,255,255,0.12);--text:#e5e7eb;--muted:#9ca3af;--primary:#60a5fa;
      --primary-600:#2563eb;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;
      --pill-bg:rgba(255,255,255,0.08);--shadow:0 10px 30px rgba(0,0,0,0.35);
      --ring:0 0 0 3px rgba(96,165,250,0.35);--radius:14px;
    }
    body{margin:0;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 800px at 10% -10%,#1f2937 0%,transparent 50%),
                 radial-gradient(1000px 700px at 110% 10%,#0ea5e9 0%,transparent 60%),
                 linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));min-height:100svh;}
    .container{max-width:1024px;margin:32px auto;padding:0 16px;}
    h1{font-weight:800;letter-spacing:.3px;margin:8px 0 22px;font-size:clamp(26px,3vw,36px);}
    .grid{display:grid;gap:16px;} @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);
      padding:18px 18px 16px;box-shadow:var(--shadow);backdrop-filter:blur(6px);
      transition:transform .15s ease,border-color .2s ease;}
    .card h2{margin:0 0 12px;font-size:18px;letter-spacing:.2px}
    .subtle{color:var(--muted);font-size:14px}
    .btn{appearance:none;border:1px solid transparent;border-radius:10px;padding:8px 12px;
      font-weight:600;letter-spacing:.2px;transition:transform .05s ease,background .15s ease,
      border-color .15s ease,color .15s ease;cursor:pointer;user-select:none}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff;
      box-shadow:0 6px 18px rgba(37,99,235,.35)}
    .btn.secondary{background:transparent;color:var(--text);border-color:rgba(255,255,255,0.2)}
    .btn.success{background:linear-gradient(180deg,#34d399,#10b981);color:#052e1f}
    .btn.danger{background:linear-gradient(180deg,#fda4af,#ef4444);color:#3b0a0a}
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
    input[type="text"],input[type="password"],input[type="number"]{background:rgba(255,255,255,0.06);color:var(--text);
      border:1px solid rgba(255,255,255,0.18);outline:none;padding:8px 10px;border-radius:10px;min-width:160px}
    input:focus{box-shadow:var(--ring);border-color:rgba(96,165,250,.5)}
    input[type="file"]{color:var(--muted)}
    code{background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:6px}
    .muted{color:var(--muted)}
    .list{display:grid;gap:10px}
    .item{border:1px dashed rgba(255,255,255,0.18);border-radius:12px;padding:12px;display:grid;gap:8px;
      background:rgba(255,255,255,0.035)}
    .item-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .item-title{font-weight:700}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-weight:700;
      font-size:12px;background:var(--pill-bg);border:1px solid rgba(255,255,255,0.16)}
    .pill.success{color:#22c55e}.pill.warn{color:#f59e0b}.pill.danger{color:#ef4444}
    .spinner{width:12px;height:12px;border-radius:999px;border:2px solid rgba(255,255,255,.2);
      border-top-color:var(--primary);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .small{font-size:12px}.sep{opacity:.35;margin:0 6px}.empty{font-style:italic;color:var(--muted);padding:6px 2px}
    .toasts{position:fixed;right:18px;bottom:18px;display:grid;gap:10px;z-index:50}
    .toast{background:rgba(17,24,39,0.9);color:#e5e7eb;border:1px solid rgba(255,255,255,0.15);border-radius:12px;
      padding:10px 12px;box-shadow:var(--shadow);min-width:220px;animation:pop .15s ease-out}
    .toast.success{border-color:rgba(16,185,129,.45)}.toast.error{border-color:rgba(239,68,68,.45)}
    @keyframes pop{from{transform:translateY(6px);opacity:0}to{transform:none;opacity:1}}
    .section-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    select.format{background:rgba(255,255,255,0.06);color:var(--text);border:1px solid rgba(255,255,255,0.18);
      padding:8px 10px;border-radius:10px}
    .pager{display:flex;align-items:center;gap:8px;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Video API Client</h1>

    <div class="grid grid-2">
      <!-- 1) Login -->
      <section class="card">
        <div class="section-head">
          <h2>1) Login</h2>
          <span class="small muted">JWT auth demo</span>
        </div>
        <div class="row">
          <label class="small">Username</label>
          <input id="u" type="text" value="admin">
          <label class="small">Password</label>
          <input id="p" type="password" value="admin123">
          <button id="btnLogin" class="btn primary">Login</button>
          <button id="btnLogout" class="btn secondary" disabled>Logout</button>
          <a id="link-signup" href="javascript:void(0)" class="small muted" style="margin-left:8px">Sign up</a>
          <a id="link-confirm" href="javascript:void(0)" class="small muted" style="margin-left:8px">Confirm</a>
        </div>
        <div class="row small">
          <span>Status:</span>
          <span id="authState" class="pill warn"><span class="spinner" style="display:none"></span> Not logged in</span>
          <span class="sep">•</span>
          <span>Balance: $<b id="bal">0.00</b></span>
          <input id="topupAmt" type="number" min="50" step="50" value="200" title="cents" style="width:110px">
          <button id="btnTopup" class="btn secondary" disabled>Top up</button>
        </div>
        <div class="small muted">Token: <code id="tok">-</code></div>
      </section>

      <!-- 2) Upload -->
      <section class="card">
        <div class="section-head">
          <h2>2) Upload</h2>
        </div>
        <div class="row">
          <input id="file" type="file" accept="video/*" disabled />
          <button id="btnUpload" class="btn primary" disabled>Upload</button>
        </div>
      </section>
    </div>

    <!-- 3A) All users' files (admin only) -->
    <section class="card" id="adminSection" style="display:none;">
      <div class="section-head">
        <h2>3A) All users' files (admin)</h2>
        <div class="actions">
          <input id="adminFilesQ" type="text" placeholder="Search filename or owner..." style="min-width:200px" disabled>
          <select id="adminFilesSort" disabled>
            <option value="uploaded_at">Uploaded time</option>
            <option value="size_bytes">Size</option>
            <option value="filename">Filename</option>
            <option value="owner">Owner</option>
          </select>
          <select id="adminFilesOrder" disabled>
            <option value="desc">Desc</option>
            <option value="asc">Asc</option>
          </select>
          <select id="adminFilesSize" disabled>
            <option value="5">5</option><option value="10" selected>10</option><option value="20">20</option>
          </select>
          <button id="btnAdminList" class="btn secondary" disabled>Refresh</button>
        </div>
      </div>
      <div id="adminFiles" class="list"></div>
      <div class="pager">
        <button id="adminFilesPrev" class="btn secondary" disabled>Prev</button>
        <span class="small">Page <b id="adminFilesPage">1</b></span>
        <button id="adminFilesNext" class="btn secondary" disabled>Next</button>
        <span class="small" id="adminFilesTotal" style="opacity:.7"></span>
      </div>
    </section>

    <!-- 3) Files -->
    <section class="card">
      <div class="section-head">
        <h2>3) Your files</h2>
        <div class="actions">
          <input id="filesQ" type="text" placeholder="Search name..." style="min-width:160px">
          <select id="filesSort">
            <option value="uploaded_at">Uploaded time</option>
            <option value="size_bytes">Size</option>
            <option value="filename">Filename</option>
          </select>
          <select id="filesOrder">
            <option value="desc">Desc</option>
            <option value="asc">Asc</option>
          </select>
          <select id="filesSize">
            <option value="5">5</option><option value="10" selected>10</option><option value="20">20</option>
          </select>
          <button id="btnList" class="btn secondary" disabled>Refresh files</button>
        </div>
      </div>
      <div id="files" class="list"></div>
      <div class="pager">
        <button id="filesPrev" class="btn secondary" disabled>Prev</button>
        <span class="small">Page <b id="filesPage">1</b></span>
        <button id="filesNext" class="btn secondary" disabled>Next</button>
        <span class="small" id="filesTotal" style="opacity:.7"></span>
      </div>
    </section>

    <!-- 4) Jobs -->
    <section class="card">
      <div class="section-head">
        <h2>4) Jobs</h2>
        <div class="actions">
          <select id="jobStatus">
            <option value="">All</option>
            <option value="running">Running</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
            <option value="queued">Queued</option>
          </select>
          <select id="jobsSort">
            <option value="updated_at">Updated</option>
            <option value="created_at">Created</option>
            <option value="status">Status</option>
          </select>
          <select id="jobsOrder">
            <option value="desc">Desc</option>
            <option value="asc">Asc</option>
          </select>
          <select id="jobsSize">
            <option value="5">5</option><option value="10" selected>10</option><option value="20">20</option>
          </select>
          <button id="btnJobs" class="btn secondary" disabled>Refresh jobs</button>
          <label class="small muted" style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="autoJobs" checked disabled>
            Auto refresh every 5s
          </label>
        </div>
      </div>
      <div id="jobs" class="list"></div>
      <div class="pager">
        <button id="jobsPrev" class="btn secondary" disabled>Prev</button>
        <span class="small">Page <b id="jobsPage">1</b></span>
        <button id="jobsNext" class="btn secondary" disabled>Next</button>
        <span class="small" id="jobsTotal" style="opacity:.7"></span>
      </div>
    </section>
  </div>

  <div class="toasts" id="toasts"></div>

<script>
// --- state & utils ---
const BASE = location.origin;
let token = null, jobsInterval = null;
let filesPage=1, jobsPage=1, adminFilesPage=1;
let isAdmin = false;


const $ = (q)=>document.querySelector(q);
function toast(msg,type="success",t=2500){const w=$("#toasts");const d=document.createElement("div");
d.className=`toast ${type}`;d.textContent=msg;w.appendChild(d);setTimeout(()=>d.remove(),t)}
function setAuthPill(text,kind){const p=$("#authState");p.className=`pill ${kind}`;
p.innerHTML=`${kind==='warn'?'<span class="spinner"></span> ':''}${text}`}

function escapeHtml(s){return (s==null)?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;')}
function setBalance(cents){ $("#bal").textContent=(Number(cents||0)/100).toFixed(2); }
function debounce(fn, delay=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }
function authHeaders(){return token?{Authorization:'Bearer '+token}:{}} 
async function guardFetch(url,opts={}){const r=await fetch(url,{...opts,headers:{...(opts.headers||{}),...authHeaders()}});
if(r.status===401){token=null;localStorage.removeItem("idToken");toggleUI(false);toast('Unauthorized','error');throw new Error('Unauthorized')} return r}

// --- signup / confirm ---
async function signupFlow(){
  const username=$("#u").value.trim(), password=$("#p").value;
  const email = prompt("Enter your email for sign-up:");
  if(!username||!password||!email){ toast('username/password/email required','error'); return; }
  const r = await fetch(BASE+'/auth/signup',{method:'POST',headers:{'content-type':'application/json'},
              body:JSON.stringify({username,password,email})});
  const j = await r.json().catch(()=>null);
  if(r.ok && (j?.ok!==false)){ toast('Sign up sent. Check your inbox (Spam).'); }
  else { toast(`Sign up failed: ${j?.error||j?.message||r.status}`, 'error'); }
}
async function confirmFlow(){
  const username=$("#u").value.trim();
  const code = prompt("Enter the 6-digit confirmation code:");
  if(!username||!code){ toast('username/code required','error'); return; }
  const r = await fetch(BASE+'/auth/confirm',{method:'POST',headers:{'content-type':'application/json'},
              body:JSON.stringify({username,code})});
  const j = await r.json().catch(()=>null);
  if(r.ok && (j?.ok!==false)){ toast('Email confirmed! You can login now.'); }
  else { toast(`Confirm failed: ${j?.error||j?.message||r.status}`, 'error'); }
}
$("#link-signup")?.addEventListener("click", signupFlow);
$("#link-confirm")?.addEventListener("click", confirmFlow);

// --- login/logout ---
$("#btnLogin").onclick = async ()=>{
  const r=await fetch(BASE+'/login',{method:'POST',headers:{'content-type':'application/json'},
    body:JSON.stringify({username:$("#u").value,password:$("#p").value})});
  const j=await r.json().catch(()=>null);
  if(!r.ok||!j?.authToken){toast(`Login failed${j?.error?`: ${j.error}`:''}`,'error');return;}
  token=j.authToken;
  localStorage.setItem("idToken", token);

  await checkAdminStatus();      // 先检测管理员身份（/auth/whoami）
  toggleUI(true);                // 打开 UI
  toast('Login successful');
};

$("#btnLogout").onclick = ()=>{
  token=null; localStorage.removeItem("idToken"); toggleUI(false); toast('Logged out')
};

async function checkAdminStatus() {
  try {
    const r = await guardFetch(BASE+'/auth/whoami');
    if (r.ok) {
      const j = await r.json();
      isAdmin = !!(j.user && j.user.admin);
    } else {
      isAdmin = false;
    }
  } catch (e) {
    console.error('Failed to check admin status:', e);
    isAdmin = false;
  }
}

// --- UI on/off （根据 isAdmin 控制 3A 的显示/可用性）---
function toggleUI(on){
  $("#file").disabled=!on;$("#btnUpload").disabled=!on;$("#btnList").disabled=!on;
  $("#btnJobs").disabled=!on;$("#btnLogout").disabled=!on;$("#btnLogin").disabled=on;$("#btnTopup").disabled=!on;
  $("#autoJobs").disabled=!on;["filesQ","filesSort","filesOrder","filesSize","jobStatus","jobsSort","jobsOrder","jobsSize"].forEach(id=>{$("#"+id).disabled=!on});
  $("#tok").textContent=on?(token.slice(0,24)+'...'):'-';

  // 管理员区显示/隐藏与控件状态
  if (isAdmin && on) {
    $("#adminSection").style.display = 'block';
    $("#btnAdminList").disabled = !on;
    ["adminFilesQ","adminFilesSort","adminFilesOrder","adminFilesSize"].forEach(id=>{$("#"+id).disabled=!on});
  } else {
    $("#adminSection").style.display = 'none';
    $("#btnAdminList").disabled = true;
    ["adminFilesQ","adminFilesSort","adminFilesOrder","adminFilesSize"].forEach(id=>{$("#"+id).disabled=true});
  }

  if(!on){
    setAuthPill('Not logged in','warn');
    $("#files").innerHTML='';$("#jobs").innerHTML='';$("#adminFiles").innerHTML='';
    clearInterval(jobsInterval);setBalance(0);
  }else{
    setAuthPill('Logged in','success');
    refreshMe();               // 拉取余额与（再次）确认 admin，并按需加载 3A 列表
    listFiles(); listJobs();
    jobsInterval=setInterval(()=>token&&listJobs(),5000)
  }
}

// --- 余额/身份信息（不会再调用 toggleUI，避免循环）---

async function refreshMe(){
  const r = await guardFetch(BASE+'/me');
  const j = await r.json().catch(()=>null);
  setBalance(j?.balance_cents||0);

  // 以 /me 返回为准更新 isAdmin 并更新 3A 区显示
  isAdmin = !!j?.admin;
  const adminSec = document.getElementById("adminSection");
  if (adminSec){
    if (isAdmin){
      adminSec.style.display='block';
      ["adminFilesQ","adminFilesSort","adminFilesOrder","adminFilesSize","btnAdminList"].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=false;});
      adminFilesPage=1; listAdminFiles(); // 初次加载
    }else{
      adminSec.style.display='none';
      ["adminFilesQ","adminFilesSort","adminFilesOrder","adminFilesSize","btnAdminList"].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=true;});
      $("#adminFiles").innerHTML='';
    }
  }
}

// --- Upload ---

$("#btnUpload").onclick = async ()=>{
  const f=$("#file").files[0]; 
  if(!f){ toast('Choose a video file first','error'); return; }

  const btn = $("#btnUpload");
  const oldText = btn.textContent;
  btn.disabled = true; btn.textContent = "Uploading…";

  const fd = new FormData(); fd.append('file', f);

  const ac = new AbortController();
  const timer = setTimeout(()=>ac.abort(), 45_000);

  let j=null, ok=false, msg='';
  try{
    const r = await guardFetch(BASE+'/upload',{ method:'POST', body:fd, signal: ac.signal });
    j = await r.json().catch(()=>null);
    ok = r.ok && j && j.ok !== false;
    msg = ok ? 'Upload successful' : ('Upload failed: '+(j?.error||r.status));
  }catch(e){
    msg = (e.name === 'AbortError') ? 'Upload timeout' : ('Upload error: '+(e.message||e));
  }finally{
    clearTimeout(timer);
    btn.disabled = false; btn.textContent = oldText;
  }

  // 展示返回体 + 如有预签名链接，放一个可点的 <a>
  if (j && j.downloadUrl){
    $("#upRes").text = JSON.stringify(j,null,2);
    const a = document.createElement('a');
    a.href = j.downloadUrl; a.target = '_blank'; a.textContent = 'Open S3 object (1 min)';
    const box = document.createElement('div'); box.style.marginTop='6px'; box.appendChild(a);
    $("#upRes").appendChild(box);
  } else {
    $("#upRes").textContent = j ? JSON.stringify(j,null,2) : msg;
  }

  toast(msg, ok ? 'success' : 'error');
  if(ok){ filesPage=1; listFiles(); }
};


// --- Files (self) ---
$("#btnList").onclick=()=>{ filesPage=1; listFiles(); };
$("#filesPrev").onclick=()=>{ if(filesPage>1){ filesPage--; listFiles(); } };
$("#filesNext").onclick=()=>{ filesPage++; listFiles(); };
$("#filesQ").oninput = debounce(()=>{ filesPage=1; listFiles(); }, 300);
$("#filesSort").onchange = ()=>{ filesPage=1; listFiles(); };
$("#filesOrder").onchange = ()=>{ filesPage=1; listFiles(); };
$("#filesSize").onchange = ()=>{ filesPage=1; listFiles(); };

// --- Admin: list all users' files ---
$("#btnAdminList")?.addEventListener("click", ()=>{ adminFilesPage=1; listAdminFiles(); });
$("#adminFilesPrev")?.addEventListener("click", ()=>{ if(adminFilesPage>1){ adminFilesPage--; listAdminFiles(); }});
$("#adminFilesNext")?.addEventListener("click", ()=>{ adminFilesPage++; listAdminFiles(); });

const adminDebouncedSearch = debounce(()=>{ adminFilesPage=1; listAdminFiles(); }, 300);
$("#adminFilesQ")?.addEventListener("input", adminDebouncedSearch);
$("#adminFilesSort")?.addEventListener("change", ()=>{ adminFilesPage=1; listAdminFiles(); });
$("#adminFilesOrder")?.addEventListener("change", ()=>{ adminFilesPage=1; listAdminFiles(); });
$("#adminFilesSize")?.addEventListener("change", ()=>{ adminFilesPage=1; listAdminFiles(); });

async function listAdminFiles(){
  if(!isAdmin) return; // safety

  const q = encodeURIComponent($("#adminFilesQ")?.value || "");
  const sort = $("#adminFilesSort")?.value || "uploaded_at";
  const order = $("#adminFilesOrder")?.value || "desc";
  const size = parseInt($("#adminFilesSize")?.value,10) || 10;

  const r = await guardFetch(`${BASE}/admin/files?page=${adminFilesPage}&size=${size}&q=${q}&sort=${sort}&order=${order}`);
  const j = await r.json().catch(()=>null);

  const total = j?.total || 0;
  const box = $("#adminFiles");
  if (!box) return;
  box.innerHTML = "";
  const items = j?.items || [];
  if (!items.length) { box.innerHTML = '<div class="empty">No files found.</div>'; return; }

  items.forEach(it=>{
    const el = document.createElement('div'); el.className='item';
    const groups = Array.isArray(it.owner_groups)
      ? it.owner_groups.join(', ')
      : (it.owner_groups ? String(it.owner_groups) : '(no group)');

    el.innerHTML=`
      <div class="item-head">
        <div class="item-title">${escapeHtml(it.filename)}</div>
        <div class="actions">
          <span class="pill">Owner: ${escapeHtml(it.owner)}</span>
          <span class="pill">Groups: ${escapeHtml(groups)}</span>
        </div>
      </div>
      <div class="small muted">
        id: <code>${escapeHtml(it.id)}</code>
        <span class="sep">•</span> ${Number(it.size_bytes||0)} bytes
        <span class="sep">•</span> uploaded: ${escapeHtml(it.uploaded_at||'-')}
      </div>`;

    box.appendChild(el);
  });

  $("#adminFilesPage").textContent = String(j?.page || adminFilesPage);
  $("#adminFilesTotal").textContent = `Total: ${total}`;
  const maxPage = Math.max(1, Math.ceil(total / size));
  $("#adminFilesPrev").disabled = (adminFilesPage<=1);
  $("#adminFilesNext").disabled = (adminFilesPage>=maxPage);
}


async function listFiles(){
  const q = encodeURIComponent($("#filesQ").value||"");
  const sort = $("#filesSort").value;
  const order = $("#filesOrder").value;
  const size = parseInt($("#filesSize").value,10)||10;

  const r=await guardFetch(`${BASE}/files?page=${filesPage}&size=${size}&q=${q}&sort=${sort}&order=${order}`);
  const j=await r.json().catch(()=>null);

  const total=j?.total||0;
  const box=$("#files"); box.innerHTML=''; const items=j&&j.items?j.items:[];
  if(!items.length){box.innerHTML='<div class="empty">No files yet.</div>';return;}
  items.forEach(it=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div class="item-head">
        <div class="item-title">${escapeHtml(it.filename)}</div>
        <div class="actions">
          <select class="format" id="fmt-${it.id}">
            <option value="mp4">MP4</option>
            <option value="webm">WEBM</option>
          </select>
          <button class="btn primary btnTrans" data-id="${it.id}">Transcode 720p</button>
          <button class="btn secondary btnDownOrig" data-id="${it.id}">Download original</button>
          <button class="btn secondary btnSubs" data-id="${it.id}">Subs</button>
          <button class="btn secondary btnMeta" data-id="${it.id}">Meta</button>
          <button class="btn secondary btnDel" data-id="${it.id}">Delete</button>
        </div>
      </div>
      <div class="small muted">
        id: <code>${escapeHtml(it.id)}</code>
        <span class="sep">•</span> ${Number(it.size_bytes||0)} bytes
        <span class="sep">•</span> uploaded: ${escapeHtml(it.uploaded_at||'-')}
      </div>`;
    box.appendChild(el);
  });
  box.querySelectorAll('.btnTrans').forEach(b=>b.onclick=()=>transcode(b.dataset.id));
  box.querySelectorAll('.btnDownOrig').forEach(b=>b.onclick=downloadOriginal);
  box.querySelectorAll('.btnDel').forEach(b=>b.onclick=async ()=>{
    if(!confirm('Delete this file?')) return;
    await guardFetch(BASE+'/files/'+encodeURIComponent(b.dataset.id),{method:'DELETE'}); listFiles(); listJobs();
  });
  box.querySelectorAll('.btnSubs').forEach(b=>b.onclick=subsFetch);
  box.querySelectorAll('.btnMeta').forEach(b=>b.onclick=showMeta);

  $("#filesPage").textContent=String(j?.page||filesPage);
  $("#filesTotal").textContent=`Total: ${total}`;
  const maxPage = Math.max(1, Math.ceil(total / size));
  $("#filesPrev").disabled = (filesPage<=1);
  $("#filesNext").disabled = (filesPage>=maxPage);
}

async function downloadOriginal(e) {
  const id = e.currentTarget.dataset.id;
  const r = await guardFetch(BASE + '/download/original/' + encodeURIComponent(id));
  if (!r.ok) { toast('Download failed', 'error'); return; }
  const data = await r.json();
  const url = data.downloadUrl;
  const a = document.createElement('a'); a.href = url; a.download = '';
  document.body.appendChild(a); a.click(); a.remove();
}

// --- top up ---
$("#btnTopup").onclick = async ()=>{
  if(!token){ toast('Please login first','error'); return; }
  const cents = parseInt($("#topupAmt").value, 10);
  if(!Number.isInteger(cents) || cents <= 0){ toast('Invalid amount','error'); return; }

  const r = await guardFetch(BASE+'/accounts/topup',{
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ amount_cents: cents })
  });
  const j = await r.json().catch(()=>null);
  if(r.ok && (j?.ok!==false)){
    toast(`Topped up $${(cents/100).toFixed(2)}`);
    refreshMe();
  }else{
    toast(`Top up failed: ${j?.error||j?.message||r.status}`,'error');
  }
};


// --- Subs / Meta ---
async function subsFetch(e){
  const id = e.currentTarget.dataset.id;
  const card = e.currentTarget.closest('.item');
  const titleEl = card?.querySelector('.item-title');
  const fallback = (titleEl?.textContent || '').replace(/\.[a-z0-9]+$/i,'').trim();

  const query = prompt('Search subtitles (title/keywords):', fallback);
  if (!query) return;

  const r = await guardFetch(`${BASE}/files/${encodeURIComponent(id)}/subs`, {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ query, languages:['en','zh','zh-CN','zh-TW'] })
  });
  if (!r.ok) {
    let msg = 'OpenSubtitles fetch failed';
    try { const j = await r.json(); if (j?.error) msg += `: ${j.error}` } catch {}
    toast(msg,'error'); return;
  }
  toast('Subtitles metadata saved (see Meta)');
}
async function showMeta(e){
  const id = e.currentTarget.dataset.id;
  const r = await guardFetch(`${BASE}/files/${encodeURIComponent(id)}/meta`);
  if(!r.ok){ toast('Failed to load metadata','error'); return; }
  const j = await r.json().catch(()=>null);
  const meta = j?.meta || null;
  const w = window.open('', '_blank', 'width=800,height=600');
  w.document.write('<pre style="font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;">'
    + (escapeHtml(JSON.stringify(meta,null,2)) || '(empty)') + '</pre>');
}

// --- Jobs ---
$("#btnJobs").onclick=()=>{ jobsPage=1; listJobs(); };
$("#jobsPrev").onclick=()=>{ if(jobsPage>1){ jobsPage--; listJobs(); } };
$("#jobsNext").onclick=()=>{ jobsPage++; listJobs(); };
$("#jobStatus").onchange = ()=>{ jobsPage=1; listJobs(); };
$("#jobsSort").onchange = ()=>{ jobsPage=1; listJobs(); };
$("#jobsOrder").onchange = ()=>{ jobsPage=1; listJobs(); };
$("#jobsSize").onchange = ()=>{ jobsPage=1; listJobs(); };

async function transcode(fileId){
  const fmtEl=document.getElementById('fmt-'+fileId);
  const format = fmtEl ? fmtEl.value : 'mp4';
  const r=await guardFetch(BASE+'/transcode/'+encodeURIComponent(fileId),{
    method:'POST',headers:{'content-type':'application/json'},
    body:JSON.stringify({ preset:'slow', crf:22, scale:'1280:720', format })
  });
  if(r.status===402){ toast('Insufficient funds. Please top up.', 'error'); return; }
  const j=await r.json().catch(()=>null);
  if(!r.ok||!j?.ok){toast('Transcode failed','error');return;}
  toast(`Transcode started → ${format}`);
  refreshMe(); listJobs();
}
async function listJobs(){
  const status = $("#jobStatus").value;
  const sort = $("#jobsSort").value;
  const order = $("#jobsOrder").value;
  const size = parseInt($("#jobsSize").value,10)||10;
  const r=await guardFetch(`${BASE}/jobs?page=${jobsPage}&size=${size}&sort=${sort}&order=${order}${status?`&status=${status}`:''}`);
  const j=await r.json().catch(()=>null);
  const total=j?.total||0;
  const box=$("#jobs"); box.innerHTML=''; const items=j&&j.items?j.items:[];
  if(!items.length){box.innerHTML='<div class="empty">No jobs yet.</div>';return;}
  items.forEach(job=>{
    const status=String(job.status||'').toLowerCase();
    const kind=status==='completed'?'success':status==='failed'?'danger':'warn';
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`
      <div class="item-head">
        <div class="item-title">Job <code>${escapeHtml(job.id)}</code></div>
        <div class="actions">
          <span class="pill ${kind}">${status==='running'?'<span class="spinner"></span> ':''}${escapeHtml(status)}</span>
          ${status==='completed'?`<button class="btn success btnDownTc" data-id="${job.id}">Download output</button>`:''}
          ${status==='completed' && job.has_thumbnail?`<button class="btn secondary btnThumb" data-id="${job.id}">Thumbnail</button>`:''}
          <button class="btn secondary btnLogs" data-id="${job.id}">Logs</button>
        </div>
      </div>
      <div class="small muted">
        progress: ${(job.progress??0).toFixed(0)}%
        <span class="sep">•</span> updated: ${escapeHtml(job.updated_at||'-')}
        <span class="sep">•</span> charged/refunded: ${(job.charged_cents/100).toFixed(2)} / ${(job.refunded_cents/100).toFixed(2)}
      </div>`;
    box.appendChild(row);
  });
  box.querySelectorAll('.btnDownTc').forEach(b=>b.onclick=downloadOutput);
  box.querySelectorAll('.btnLogs').forEach(b=>b.onclick=showLogs);
  box.querySelectorAll('.btnThumb').forEach(b=>b.onclick=showThumb);

  $("#jobsPage").textContent=String(j?.page||jobsPage);
  $("#jobsTotal").textContent=`Total: ${total}`;
  const maxPage = Math.max(1, Math.ceil(total / size));
  $("#jobsPrev").disabled = (jobsPage<=1);
  $("#jobsNext").disabled = (jobsPage>=maxPage);
}
async function showLogs(e){
  const jobId=e.currentTarget.dataset.id;
  const r=await guardFetch(BASE+'/jobs/'+encodeURIComponent(jobId)+'/logs');
  const text=await r.text();
  const w=window.open('','_blank','width=800,height=600');
  w.document.write('<pre style="font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;">'+(escapeHtml(text)||'(empty)')+'</pre>');
}
async function showThumb(e){
  const jobId=e.currentTarget.dataset.id;
  window.open(`${BASE}/jobs/${encodeURIComponent(jobId)}/thumbnail`,'_blank','width=800,height=600');
}
async function downloadOutput(e){
  const jobId=e.currentTarget.dataset.id;
  const r=await guardFetch(BASE+'/download/transcoded/'+encodeURIComponent(jobId));
  if(r.status===409){ toast('Output not ready yet','error'); return; }
  if(!r.ok){ toast('Download failed','error'); return; }

  const data = await r.json();
  const url = data.downloadUrl;
  const a = document.createElement('a'); a.href = url; a.download = '';
  document.body.appendChild(a); a.click(); a.remove();
}

// --- Admin files (3A) ---
$("#btnAdminList").onclick=()=>{ adminFilesPage=1; listAdminFiles(); };
$("#adminFilesPrev").onclick=()=>{ if(adminFilesPage>1){ adminFilesPage--; listAdminFiles(); } };
$("#adminFilesNext").onclick=()=>{ adminFilesPage++; listAdminFiles(); };
$("#adminFilesQ").oninput = debounce(()=>{ adminFilesPage=1; listAdminFiles(); }, 300);
$("#adminFilesSort").onchange = ()=>{ adminFilesPage=1; listAdminFiles(); };
$("#adminFilesOrder").onchange = ()=>{ adminFilesPage=1; listAdminFiles(); };
$("#adminFilesSize").onchange = ()=>{ adminFilesPage=1; listAdminFiles(); };

// --- Init: try existing token ---
(async function initAuthFromStorage(){
  const saved = localStorage.getItem("idToken");
  if (saved) {
    token = saved;
    await checkAdminStatus();

    toggleUI(true);
  } else {
    toggleUI(false);
  }
})();
</script>
</body>
</html>
